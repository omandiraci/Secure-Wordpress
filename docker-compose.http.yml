version: "3.9"

services:
  # =====================
  # ðŸ”’ Traefik - Reverse Proxy (HTTP Only)
  # =====================
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --log.level=INFO
      - --accesslog=true
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./logs/traefik:/var/log/traefik
    networks:
      - wpnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`localhost`) && PathPrefix(`/api`)"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.dashboard.rule=Host(`localhost`) && PathPrefix(`/dashboard`)"
      - "traefik.http.routers.dashboard.entrypoints=web"
      - "traefik.http.routers.dashboard.service=api@internal"

  # =====================
  # ðŸ—„ï¸ MySQL Database
  # =====================
  db:
    image: mysql:8.0
    container_name: mysqlsunucu
    restart: unless-stopped
    env_file:
      - .env
    command: >
      --log-error=/var/log/mysql/error.log
      --general-log=0
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=2
      --max_connections=100
      --innodb_buffer_pool_size=256M
      --innodb_flush_log_at_trx_commit=1
      --skip-symbolic-links
      --skip-name-resolve
    volumes:
      - mysqlvolume:/var/lib/mysql
      - ./logs/database:/var/log/mysql
    networks:
      - wpnet
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
      - /var/run/mysqld
    labels:
      - "traefik.enable=false"

  # =====================
  # ðŸ“° WordPress
  # =====================
  wordpress:
    image: wordpress:6.5-apache
    container_name: wpsunucu
    depends_on:
      - db
    restart: unless-stopped
    env_file:
      - .env
    environment:
      WORDPRESS_CONFIG_EXTRA: |
        define('DISALLOW_FILE_EDIT', true);
        define('DISALLOW_FILE_MODS', true);
        define('FORCE_SSL_ADMIN', false);
        define('WP_POST_REVISIONS', 3);
        define('AUTOSAVE_INTERVAL', 300);
        define('WP_CRON_LOCK_TIMEOUT', 60);
        define('EMPTY_TRASH_DAYS', 7);
        define('WP_ALLOW_REPAIR', false);
        define('DISABLE_WP_CRON', false);
        define('WP_MEMORY_LIMIT', '256M');
        define('WP_MAX_MEMORY_LIMIT', '512M');
      APACHE_SERVER_NAME: localhost
    volumes:
      - wpvolume:/var/www/html
      - ./logs/wordpress:/var/log/apache2
    networks:
      - wpnet
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
      - /var/run/apache2
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wordpress.rule=Host(`localhost`)"
      - "traefik.http.routers.wordpress.entrypoints=web"
      - "traefik.http.services.wordpress.loadbalancer.server.port=80"

  # =====================
  # ðŸ“Š Prometheus
  # =====================
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - wpnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`localhost`) && PathPrefix(`/prometheus`)"
      - "traefik.http.routers.prometheus.entrypoints=web"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

  # =====================
  # ðŸ“ˆ Grafana
  # =====================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SECURITY_DISABLE_GRAVATAR=true
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - wpnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`localhost`) && PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=web"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # =====================
  # ðŸ§­ Portainer
  # =====================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    networks:
      - wpnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`localhost`) && PathPrefix(`/portainer`)"
      - "traefik.http.routers.portainer.entrypoints=web"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

volumes:
  mysqlvolume:
  wpvolume:
  prometheus-data:
  grafana-data:
  portainer-data:

networks:
  wpnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
