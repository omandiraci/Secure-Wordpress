version: "3.9"

services:
  # =====================
  # üîí Traefik - Reverse Proxy ve SSL
  # =====================
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${ADMIN_EMAIL:-admin@localhost}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      - --log.level=INFO
      - --accesslog=true
    ports:
      - "80:80"
      - "443:443"
      # Dashboard'a dƒ±≈ü eri≈üimi √ºretim ortamƒ±nda kapatmak daha g√ºvenli olur
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-ssl:/letsencrypt
      - ./logs/traefik:/var/log/traefik
    networks:
      - wpnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.routers.traefik.service=api@internal"

  # =====================
  # üóÑÔ∏è MySQL Database
  # =====================
  db:
    image: mysql:8.0
    container_name: mysqlsunucu
    restart: unless-stopped
    env_file:
      - .env
    command: >
      --log-error=/var/log/mysql/error.log
      --general-log=0
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=2
      --max_connections=100
      --innodb_buffer_pool_size=256M
      --innodb_flush_log_at_trx_commit=1
      --skip-symbolic-links
      --skip-name-resolve
    volumes:
      - mysqlvolume:/var/lib/mysql
      - ./logs/database:/var/log/mysql
    networks:
      - wpnet
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/run/mysqld
    labels:
      - "traefik.enable=false"

  # =====================
  # üì∞ WordPress
  # =====================
  wordpress:
    image: wordpress:6.5-apache
    container_name: wpsunucu
    depends_on:
      - db
    restart: unless-stopped
    env_file:
      - .env
    environment:
      WORDPRESS_CONFIG_EXTRA: |
        define('DISALLOW_FILE_EDIT', true);
        define('DISALLOW_FILE_MODS', true);
        define('FORCE_SSL_ADMIN', true);
        define('WP_POST_REVISIONS', 3);
        define('AUTOSAVE_INTERVAL', 300);
        define('WP_CRON_LOCK_TIMEOUT', 60);
        define('EMPTY_TRASH_DAYS', 7);
        define('WP_ALLOW_REPAIR', false);
        define('DISABLE_WP_CRON', false);
        define('WP_MEMORY_LIMIT', '256M');
        define('WP_MAX_MEMORY_LIMIT', '512M');
    volumes:
      - wpvolume:/var/www/html
      - ./logs/wordpress:/var/log/apache2
    networks:
      - wpnet
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
      - /var/run/apache2
    labels:
      - "traefik.enable=true"
      # HTTP router (t√ºm hostlar i√ßin - test ve √ºretim)
      - "traefik.http.routers.wordpress-http.rule=Host(`${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.wordpress-http.entrypoints=web"
      - "traefik.http.routers.wordpress-http.service=wordpress"
      # HTTPS router (SSL sertifikasƒ± varsa)
      - "traefik.http.routers.wordpress-https.rule=Host(`${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.wordpress-https.entrypoints=websecure"
      - "traefik.http.routers.wordpress-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.wordpress-https.service=wordpress"
      # Service definition
      - "traefik.http.services.wordpress.loadbalancer.server.port=80"

  # =====================
  # üõ°Ô∏è Fail2Ban - Brute Force Protection
  # =====================
  fail2ban:
    image: lscr.io/linuxserver/fail2ban:latest
    container_name: fail2ban
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Istanbul
      - VERBOSITY=-vv
    volumes:
      - ./fail2ban:/config
      - ./logs:/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - wpnet
    restart: unless-stopped
    labels:
      - "traefik.enable=false"

  # =====================
  # üîÑ Watchtower - Otomatik G√ºncellemeler
  # =====================
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400
      - WATCHTOWER_INCLUDE_STOPPED=true
      - WATCHTOWER_NOTIFICATIONS=email
      - WATCHTOWER_NOTIFICATION_EMAIL_FROM=watchtower@localhost
      - WATCHTOWER_NOTIFICATION_EMAIL_TO=admin@localhost
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER=smtp.gmail.com
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=587
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER=${SMTP_USER}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD=${SMTP_PASS}
    restart: unless-stopped
    labels:
      - "traefik.enable=false"

  # =====================
  # üìä Prometheus
  # =====================
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - wpnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`monitor.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.prometheus.entrypoints=web"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

  # =====================
  # üìà Grafana
  # =====================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SECURITY_DISABLE_GRAVATAR=true
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - wpnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`dashboard.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.grafana.entrypoints=web"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # =====================
  # üß≠ Portainer
  # =====================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    networks:
      - wpnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`docker.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.portainer.entrypoints=web"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

  # =====================
  # üíæ Restic - Backup
  # =====================
  restic-backup:
    image: restic/restic
    container_name: restic-backup
    volumes:
      - ./backups:/backups
      - ./restic-config:/config
      - mysqlvolume:/mysql:ro
      - wpvolume:/wordpress:ro
    environment:
      - RESTIC_REPOSITORY=/backups
      - RESTIC_PASSWORD=${BACKUP_PASSWORD}
    command: /config/backup.sh
    restart: "no"
    labels:
      - "traefik.enable=false"

volumes:
  mysqlvolume:
  wpvolume:
  traefik-ssl:
  prometheus-data:
  grafana-data:
  portainer-data:

networks:
  wpnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
